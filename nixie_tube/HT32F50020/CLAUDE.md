# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Embedded firmware project for the **Holtek HT32F50020** ARM Cortex-M0+ microcontroller (SSOP24 package). This is a medical device application developed using Keil MDK-ARM v5 IDE.

- **Target MCU**: HT32F50020 (ARM Cortex-M0+)
- **IDE**: Keil MDK-ARM v5
- **Firmware Library**: HT32 Standard Firmware Library v1.15.4
- **Code Generator**: HT32CodeConfig V1.1.5 Build 250402

## Build System

This project uses **Keil MDK-ARM** as the primary build system. There is no Makefile or command-line build support.

### Building the Project

1. Open [project/MDK_ARMv5/project.uvprojx](project/MDK_ARMv5/project.uvprojx) in Keil MDK-ARM v5
2. Build using Keil's GUI (Project → Build Target) or F7
3. Flash using Keil's debug interface with the configured debugger

### Keil Command Line (if needed)

```bash
# From project/MDK_ARMv5/ directory
UV4 -b project.uvprojx  # Build project
UV4 -r project.uvprojx  # Build and run/debug
```

Note: `UV4` is the Keil command-line tool (path may vary by installation).

## Code Architecture

### Directory Structure

```
HT32F50020_SSOP24/
├── cfg.ht32                      # Hardware configuration (HT32CodeConfig XML)
├── project/                      # Application code (~1500 LOC)
│   ├── main.c                    # Entry point with main loop
│   ├── GPIO.c/.h                 # GPIO pin configuration (PB7, PB8, soft I2C)
│   ├── UART0.c/.h                # Serial interface (115200 baud, 256-byte buffer)
│   ├── BFTM0.c/.h                # Basic Flexible Timer (100ms tick)
│   ├── ht32f5xxxx_conf.h         # Library configuration
│   ├── ht32f5xxxx_01_it.c        # Interrupt handlers
│   ├── system_ht32f5xxxx_13.c    # System initialization
│   └── MDK_ARMv5/                # Keil project files
│       ├── project.uvprojx       # Main Keil project file
│       └── startup_ht32f5xxxx_13.s  # ARM assembly startup code
├── library/                      # Firmware libraries
│   ├── CMSIS/                    # ARM CMSIS v5 standard
│   ├── Device/Holtek/HT32F5xxxx/Include/  # Device headers
│   ├── HT32F5xxxx_Driver/        # HAL drivers (54 drivers, 99 headers)
│   └── HT32_USBD_Library/        # USB Device library
└── utilities/                    # Utility code
    ├── common/                   # Ring buffer, I2C EEPROM, SPI Flash, LCD drivers
    ├── HT32_Board/               # Board support packages
    └── middleware/               # Additional middleware
```

### Main Application Flow

The application follows a simple superloop architecture with timer-based polling:

```c
main() {
    GPIO_Configuration();    // Initialize GPIO pins
    BFTM0_Configuration();   // Setup 100ms timer interrupt
    UART0_Configuration();   // Setup serial port

    while(1) {
        if(Watchdog_enabled) WDT_Restart();  // Service watchdog
        if(bftm0_ct >= 100) {                // Every 100ms (10Hz)
            bftm0_ct = 0;
            // Application-specific code here
        }
    }
}
```

### Key Configuration Concepts

1. **Hardware Configuration** ([cfg.ht32](cfg.ht32))
   - XML-based configuration file for HT32CodeConfig tool
   - Defines GPIO pins, peripheral assignments, and AFIO settings
   - Changes to hardware configuration should be made in HT32CodeConfig GUI, which regenerates code

2. **Library Configuration** ([project/ht32f5xxxx_conf.h](project/ht32f5xxxx_conf.h))
   - Enables/disables HAL drivers by defining macros
   - Configures retarget settings for printf/scanf (currently UART0 @ 115200 baud)
   - Defines clock settings and interrupt modes

3. **Generated vs. Manual Code**
   - Files with header comment "Generated by HT32CodeConfig" should not be manually edited
   - Regeneration from HT32CodeConfig will overwrite manual changes
   - Application logic should be added in designated sections of [main.c](project/main.c)

### Peripheral Modules

| Module | File | Purpose |
|--------|------|---------|
| GPIO | [project/GPIO.c](project/GPIO.c) | PB7/PB8 output pins, software I2C (SDA/SCL on PB7/PB8) |
| UART0 | [project/UART0.c](project/UART0.c) | Serial communication with 256-byte ring buffer, FIFO |
| BFTM0 | [project/BFTM0.c](project/BFTM0.c) | Basic timer generating 100ms interrupts (`bftm0_ct` counter) |

### GPIO Pin Definitions

GPIO pins use macro-based abstraction for hardware independence:

```c
// Example from GPIO.h
OUT_PB7_HIGH    // Set PB7 high
OUT_PB7_LOW     // Set PB7 low
OUT_PB7_XOR     // Toggle PB7
OUT_PB7_STATE   // Read PB7 state
```

Similar macros exist for OUT_PB8, SOFT_SDA, and SOFT_SCL pins.

### UART Communication

UART0 provides serial interface with buffering:

```c
void UART0_tx_data(u8 *pt, u8 len);  // Transmit data
void UART0_analyze_data(void);        // Process received data
```

- Baud rate: 115200
- Buffer size: 256 bytes (ring buffer)
- Retarget enabled: printf/scanf work through UART0

### HAL Driver Library

The [library/HT32F5xxxx_Driver](library/HT32F5xxxx_Driver/) directory contains 54 peripheral drivers:

- **Communication**: UART, USART, SPI, I2C, I2S, CAN, USB
- **Timers**: BFTM, GPTM, MCTM, SCTM, PDMA
- **Analog**: ADC, DAC, CMP
- **Power/Clock**: PWRCU, CKCU, RSTCU
- **Memory**: Flash, EBI
- **Security**: AES encryption
- **Display**: LCD, LEDC
- **Others**: WDT, RTC, CRC

Drivers are conditionally compiled based on definitions in [project/ht32f5xxxx_conf.h](project/ht32f5xxxx_conf.h).

## Important Development Notes

### Working with Generated Code

- **DO NOT** manually edit files marked "Generated by HT32CodeConfig"
- Use HT32CodeConfig tool (GUI) to modify hardware configuration in [cfg.ht32](cfg.ht32)
- After regeneration, application code in designated sections must be re-added

### Adding New Features

1. **New Peripheral**:
   - Configure in HT32CodeConfig tool
   - Enable driver in [project/ht32f5xxxx_conf.h](project/ht32f5xxxx_conf.h)
   - Add initialization in module-specific file (e.g., `SPIx_Configuration()`)
   - Call from [main.c](project/main.c)

2. **Application Logic**:
   - Add periodic tasks inside the `if(bftm0_ct >= 100)` block in [main.c](project/main.c)
   - For immediate response, consider adding interrupt handlers in [project/ht32f5xxxx_01_it.c](project/ht32f5xxxx_01_it.c)

### Debugging

Keil MDK provides comprehensive debugging support:

1. **Stack Usage Analysis**:
   - Enable `HTCFG_STACK_USAGE_ANALYSIS` in [project/ht32f5xxxx_conf.h](project/ht32f5xxxx_conf.h)
   - Call `StackUsageAnalysisInit(0)` at start of `main()`
   - View in Keil: View → Watch Window → HT32 Stack Usage Analysis

2. **Debug Configuration**: [project/MDK_ARMv5/HT32F5xxxx_01_DebugSupport.ini](project/MDK_ARMv5/HT32F5xxxx_01_DebugSupport.ini)

3. **Serial Debug Output**: Use `printf()` (retargeted to UART0)

### Memory Constraints

HT32F50020 specifications:
- Flash: 32 KB
- RAM: 4 KB
- Be mindful of stack/heap usage in this constrained environment

### Timer System

The BFTM0 timer provides the main timing source:
- **Interrupt Rate**: 10 Hz (every 100ms)
- **Counter Variable**: `bftm0_ct` (incremented in ISR)
- **Usage Pattern**: Check `if(bftm0_ct >= 100)` in main loop for 100ms tasks

## Holtek Library Documentation

The comprehensive firmware library documentation can be found in:
- [Release_Notes.txt](Release_Notes.txt) - Version history and changes
- Library version: v1.15.4 (Released 2025-04-02)

Supported device variants include HT32F50020, HT32F50030, and many others in the HT32F5xxxx family.
